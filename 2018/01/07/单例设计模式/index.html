<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>单例设计模式 | CrazyIT</title>
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url(/assets/header.png)">
        <div class='av-pic' style="background-image: url(/assets/tree_small.png)">
        </div>
    </section>
    <section class='menu'>
        <div>CrazyIT</div>
        
            <div>Toss more than life</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/categories/" class="Btn">
              <li>Categories</li>
            </a>  
          
            <a href="/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/dicheng52119">
                    <img src="/assets/github.svg" />
                </a>
            
        
            
                <a href="https://www.facebook.com/profile.php?id=100023446571362">
                    <img src="/assets/facebook.svg" />
                </a>
            
        
            
                <a href="https://www.zhihu.com/people/yixie-zhi-qiu-16-96-61/activities">
                    <img src="/assets/zhihu.svg" />
                </a>
            
        
            
                <a href="https://www.csdn.net/">
                    <img src="/assets/csdn.svg" />
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>单例设计模式</h1>
    </header>

    <section>
      <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>java中单例模式是一种常见的设计模式，单例模式的写法有好几种，这里主要介绍三种：懒汉式单例、饿汉式单例、登记式单例。</p>
<p>单例模式有以下特点：</p>
<ol>
<li>单例类只能有一个实例。</li>
<li>单例类必须自己创建自己的唯一实例。</li>
<li>单例类必须给所有其他对象提供这一实例。</li>
</ol>
<p>单例模式确保某个类只有一个实例，而且自行实例化并向整个系统提供这个实例。在计算机系统中，线程池、缓存、日志对象、对话框、打印机、显卡的驱动程序对象常被设计成单例。这些应用都或多或少具有资源管理器的功能。每台计算机可以有若干个打印机，但只能有一个Printer Spooler，以避免两个打印作业同时输出到打印机中。每台计算机可以有若干通信端口，系统应当集中管理这些通信端口，以避免一个通信端口同时被两个请求同时调用。总之，选择单例模式就是为了避免不一致状态，避免政出多头。</p>
<h3 id="单例模式的实现方式-列出6种可行的实现"><a href="#单例模式的实现方式-列出6种可行的实现" class="headerlink" title="单例模式的实现方式(列出6种可行的实现)"></a>单例模式的实现方式(列出6种可行的实现)</h3><p>饿汉式和懒汉式是以往最经典和常用的方式。</p>
<a id="more"></a>
<ul>
<li><strong>饿汉式(静态常量)</strong></li>
</ul>
<p><img src="https://github.com/dicheng52119/dicheng52119.github.io/blob/master/images/design-mode/%E9%A5%BF%E6%B1%89%E9%9D%99%E6%80%81%E5%B8%B8%E9%87%8F%E6%96%B9%E5%BC%8F.png?raw=true" alt=""></p>
<p>该方式不能实现懒加载、参数化、配置化，简单地说就是不够灵活。但却是一种简单可行的方式，在Java jdk中就有用到该方式实现单例，例如Runtime类。虽然jdk中没有使用final，但达到的效果是相同的，该方式还能用静态代码块实现。</p>
<ul>
<li><strong>饿汉式(静态代码块)</strong></li>
</ul>
<p><img src="https://github.com/dicheng52119/dicheng52119.github.io/blob/master/images/design-mode/%E9%A5%BF%E6%B1%89%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E5%9D%97%E6%96%B9%E5%BC%8F.png?raw=true" alt=""></p>
<p>该方式效果和优缺点同上。</p>
<ul>
<li><strong>懒汉式(线程同步)</strong></li>
</ul>
<p><img src="https://github.com/dicheng52119/dicheng52119.github.io/blob/master/images/design-mode/%E6%87%92%E6%B1%89%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F.png?raw=true" alt=""></p>
<p>该方式达到了实现懒加载、可参数化、可配置化的要求，但是明显的缺点就是效率太低。</p>
<ul>
<li><strong>懒汉式（双重检查）</strong></li>
</ul>
<p><img src="https://github.com/dicheng52119/dicheng52119.github.io/blob/master/images/design-mode/%E6%87%92%E6%B1%89%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E6%96%B9%E5%BC%8F.png?raw=true" alt=""></p>
<p>该方式值得推荐使用，使用该方式需要对线程知识有一定的了解。使用volatile关键字使得单例对象具有可见性，通知多线程中的其他线程去主存中获取单例对象。但不能保证原子性，所以需要使用synchronized关键字保证原子性操作。</p>
<p>除了饿汉式和懒汉式，下面笔者再提供两种值得推荐的方式。</p>
<ul>
<li><strong>静态内部类</strong></li>
</ul>
<p><img src="https://github.com/dicheng52119/dicheng52119.github.io/blob/master/images/design-mode/%E9%9D%99%E6%80%81%E5%86%85%E9%83%A8%E7%B1%BB%E6%96%B9%E5%BC%8F.png?raw=true" alt=""></p>
<p>该方式类似于饿汉式和懒汉式的结合版，既避免了线程同步问题，又支持延迟加载，还提高了效率。类加载时没有进行单例对象的初始化，而是在获取实例对象时通过调用其静态内部类获取单例的静态常量对象来进行实现。</p>
<ul>
<li><strong>枚举式</strong></li>
</ul>
<p><img src="https://github.com/dicheng52119/dicheng52119.github.io/blob/master/images/design-mode/%E6%9E%9A%E4%B8%BE%E6%96%B9%E5%BC%8F.png?raw=true" alt=""></p>
<p>该方式简单直接。不过目前使用的频率不高，可能是因为枚举是在JDK1.5之后的新特性的原因，大家还未习惯使用枚举吧。</p>
<p>以上六种方式均为可行的实现单例模式的方式，可根据具体需求进行选择。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ol>
<li>应用程序的日志应用，一般都应用单例模式实现，这一般是由于共享的日志文件一直处于打开状态，因为只能有一个实例去操作，否则内容不好追加。</li>
<li>Web应用的配置对象的读取，一般也应用单例模式，这个是由于配置文件是共享的资源。</li>
<li>数据库连接池的设计一般也是采用单例模式，因为数据库连接是一种数据库资源。数据库软件系统中使用数据库连接池，主要是节省打开或者关闭数据库连接所引起的效率损耗，这种效率上的损耗还是非常昂贵的，用单例模式来维护，就可以大大降低这种损耗。</li>
<li>多线程的线程池的设计一般也是采用单例模式，这是由于线程池要方便对池中的线程进行控制。</li>
<li>操作系统的文件系统，也是大的单例模式实现的具体例子，一个操作系统只能有一个文件系统。</li>
<li>HttpApplication也是单例的典型应用。熟悉ASP.Net(IIS)的整个请求生命周期的人应该知道HttpApplication也是单例模式，所有的HttpModule都共享一个HttpApplication实例。</li>
</ol>
<p>简单的说说单例的目的：资源共享，避免多次创建对象，以提高性能。资源控制，方便资源之间的互相通信。</p>
<p>单例模式与垃圾回收：单例模式创建的对象会不会被垃圾回收机制回收？这是一个饱受争议的问题，网上各种水平的人，包括所谓的“技术大牛”都持有不同观点。但是笔者可以在这里明确的告诉大家，一个单例对象即使长时间未被引用也不会被垃圾回收机制给卸载掉。关于垃圾回收（GC）的底层原理，不属于本文范围，在此不做过多讲解。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSingleton</span> </span>&#123;  </span><br><span class="line">    String name = <span class="keyword">null</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">TestSingleton</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> TestSingleton instance = <span class="keyword">null</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TestSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">           <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;    </span><br><span class="line">             <span class="keyword">synchronized</span> (TestSingleton.class) &#123;    </span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;    </span><br><span class="line">                   instance = <span class="keyword">new</span> TestSingleton();   </span><br><span class="line">                &#125;    </span><br><span class="line">             &#125;    </span><br><span class="line">           &#125;   </span><br><span class="line">           <span class="keyword">return</span> instance;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">"the name is "</span> + name);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TMain</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;  </span><br><span class="line">        TestStream ts1 = TestSingleton.getInstance();  </span><br><span class="line">        ts1.setName(<span class="string">"jason"</span>);  </span><br><span class="line">        TestStream ts2 = TestSingleton.getInstance();  </span><br><span class="line">        ts2.setName(<span class="string">"0539"</span>);  </span><br><span class="line">          </span><br><span class="line">        ts1.printInfo();  </span><br><span class="line">        ts2.printInfo();  </span><br><span class="line">          </span><br><span class="line">        <span class="keyword">if</span>(ts1 == ts2)&#123;  </span><br><span class="line">            System.out.println(<span class="string">"创建的是同一个实例"</span>);  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            System.out.println(<span class="string">"创建的不是同一个实例"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">the name is 0539</span><br><span class="line">the name is 0539</span><br><span class="line">创建的是同一个实例</span><br></pre></td></tr></table></figure></p>
<p>结论：由结果可以得知单例模式为一个面向对象的应用程序提供了对象惟一的访问点，不管它实现何种功能，整个应用程序都会同享一个实例对象。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>饿汉式和懒汉式区别</strong></li>
</ul>
<ol>
<li>单例对象初始化时间：<br>饿汉就是类一旦加载，就把单例初始化完成，保证getInstance的时候，单例是已经存在的了，而懒汉比较懒，只有当调用getInstance的时候，才回去初始化这个单例。</li>
<li>线程安全：<br>饿汉式天生就是线程安全的，可以直接用于多线程而不会出现问题，<br>懒汉式本身是非线程安全的，为了实现线程安全有几种写法，在资源加载和性能方面有些区别。</li>
<li>资源加载和性能：<br>饿汉式在类创建的同时就实例化一个静态对象出来，不管之后会不会使用这个单例，都会占据一定的内存，但是相应的，在第一次调用时速度也会更快，因为其资源已经初始化完成，<br>而懒汉式顾名思义，会延迟加载，在第一次使用该单例的时候才会实例化对象出来，第一次调用时要做初始化，如果要做的工作比较多，性能上会有些延迟，之后就和饿汉式一样了。</li>
</ol>
<p>至于3、4、5这三种实现又有些区别：</p>
<p>第3种，在方法调用上加了同步，虽然线程安全了，但是每次都要同步，会影响性能，毕竟99%的情况下是不需要同步的。</p>
<p>第4种，在getInstance中做了两次null检查，确保了只有第一次调用单例的时候才会做同步，这样也是线程安全的，同时避免了每次都同步的性能损耗。</p>
<p>第5种，利用了classloader的机制来保证初始化instance时只有一个线程，所以也是线程安全的，同时没有性能损耗，所以一般我倾向于使用这一种。</p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2018-01-07T12:31:50.000Z" itemprop="datePublished">
              2018-01-07
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/technology/">technology</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/design-pattern/">design pattern</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/单例/">单例</a> }
  </li>


            </div>
          
      </section>
    
    
</article>

  
</div>

            <footer>
    <div>© 2015 - Mr.CrazyDC </div>
    <div>
    Powered by Hexo
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>